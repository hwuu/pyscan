<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyScan Bug Report - {{ timestamp }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* é¡¶éƒ¨ç»Ÿè®¡é¢æ¿ */
        .stats-pane {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stats-pane h1 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 10px 12px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 3px;
        }

        .stat-value {
            font-size: 22px;
            font-weight: bold;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* å·¦ä¾§ Bug åˆ—è¡¨ */
        .bugs-pane {
            width: 40%;
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
        }

        .filter-section {
            margin-bottom: 0;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
            margin-bottom: 6px;
        }

        .filter-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        select.filter-select {
            width: 100%;
            padding: 5px 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            font-size: 12px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            outline: none;
        }

        select.filter-select option {
            background: #667eea;
            color: white;
        }

        select.filter-select:focus {
            border-color: rgba(255,255,255,0.5);
        }

        .bugs-list {
            flex: 1;
        }

        .bug-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .bug-item:hover {
            background: #f9f9f9;
        }

        .bug-item.selected {
            background: #e8eaf6;
            border-left: 4px solid #667eea;
        }

        .bug-id {
            display: inline-block;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
            margin-right: 8px;
        }

        .bug-severity {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .bug-severity.high {
            background: #ffebee;
            color: #c62828;
        }

        .bug-severity.medium {
            background: #fff3e0;
            color: #e65100;
        }

        .bug-severity.low {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .bug-type {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
            color: #333;
        }

        .bug-location {
            font-size: 12px;
            color: #666;
            font-family: 'Courier New', monospace;
        }

        /* å³ä¾§ä»£ç é¢æ¿ */
        .code-pane {
            flex: 1;
            background: #1e1e1e;
            color: #d4d4d4;
            overflow-y: auto;
            padding: 20px;
        }

        .code-header {
            color: #9cdcfe;
            font-size: 14px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #3e3e3e;
        }

        .code-content {
            font-family: 'Courier New', Consolas, Monaco, monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .code-line {
            display: flex;
        }

        .line-number {
            color: #858585;
            padding-right: 20px;
            user-select: none;
            text-align: right;
            min-width: 50px;
        }

        .line-content {
            flex: 1;
        }

        .code-line.highlighted {
            background: rgba(255, 87, 51, 0.2);
            border-left: 3px solid #ff5733;
        }

        .bug-details {
            background: #252526;
            padding: 10px 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            border-left: 4px solid #ff5733;
        }

        .bug-details h3 {
            color: #ff5733;
            font-size: 14px;
            margin: 0 0 8px 0;
        }

        .bug-details p {
            margin: 0 0 4px 0;
            line-height: 1.4;
            font-size: 13px;
        }

        .bug-details .label {
            color: #9cdcfe;
            font-weight: 600;
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 14px;
        }

        /* Caller å±•ç¤ºæ ·å¼ */
        .caller-section {
            margin-top: 20px;
            border-top: 2px solid #3e3e3e;
            padding-top: 15px;
        }

        .caller-header {
            color: #4ec9b0;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #2d2d2d;
            border-left: 4px solid #4ec9b0;
        }

        .caller-item {
            margin-bottom: 15px;
            background: #252526;
            border-radius: 4px;
            padding: 12px;
            border-left: 3px solid #569cd6;
        }

        .caller-label {
            color: #569cd6;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .caller-hint {
            color: #ce9178;
            font-size: 12px;
            font-style: italic;
            margin-bottom: 8px;
        }

        .caller-code {
            font-family: 'Courier New', Consolas, Monaco, monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #d4d4d4;
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .caller-code .call-line {
            background: rgba(255, 215, 0, 0.15);
            border-left: 3px solid #ffd700;
            padding-left: 8px;
            margin-left: -8px;
            display: block;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨è¿‡æ»¤/æ’åºé¢æ¿ -->
        <div class="stats-pane">
            <h1>ğŸ” PyScan Bug Report</h1>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                <!-- Severity ç­›é€‰ -->
                <div class="filter-section">
                    <div class="filter-label">Severity</div>
                    <select class="filter-select" id="severityFilter">
                        <option value="all">All Severities</option>
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </select>
                </div>

                <!-- File Path ç­›é€‰ -->
                <div class="filter-section">
                    <div class="filter-label">File Path</div>
                    <select class="filter-select" id="pathFilter">
                        <option value="all">All Paths</option>
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </select>
                </div>

                <!-- Bug Type ç­›é€‰ -->
                <div class="filter-section">
                    <div class="filter-label">Bug Type</div>
                    <select class="filter-select" id="typeFilter">
                        <option value="all">All Types</option>
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </select>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- å·¦ä¾§ Bug åˆ—è¡¨ -->
            <div class="bugs-pane">
                <div class="bugs-list" id="bugsList">
                    <!-- Bug items will be inserted here by JavaScript -->
                </div>
            </div>

            <!-- å³ä¾§ä»£ç é¢æ¿ -->
            <div class="code-pane">
                <div class="empty-state">
                    ğŸ‘ˆ Select a bug from the list to view details
                </div>
            </div>
        </div>
    </div>

    <script>
        // Bug æ•°æ®
        const bugsData = {{ bugs_json }};

        // æºç æ–‡ä»¶æ•°æ®ï¼ˆå¦‚æœåµŒå…¥æ¨¡å¼ï¼‰
        const sourceFiles = {{ source_files_json }};
        const embedMode = {{ embed_source }};

        let currentFilters = {
            severity: 'all',
            path: 'all',
            type: 'all'
        };
        let selectedBugIndex = -1;

        // åˆå§‹åŒ–
        function init() {
            generateFilterOptions();
            setupFilterControls();
            renderBugsList();

            // å¤„ç† URL hashï¼Œè‡ªåŠ¨å®šä½åˆ°ç›¸åº”çš„ bug
            handleUrlHash();
        }

        // ç”Ÿæˆç­›é€‰é€‰é¡¹å’Œç»Ÿè®¡ï¼ˆè”åŠ¨ï¼šæ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶æ›´æ–°å¯ç”¨é€‰é¡¹ï¼‰
        function generateFilterOptions() {
            // è·å–å½“å‰ç­›é€‰åçš„ bugsï¼ˆç”¨äºè®¡ç®—è”åŠ¨åçš„ç»Ÿè®¡ï¼‰
            const currentBugs = getFilteredBugs();

            // ç»Ÿè®¡æ¯ä¸ªç»´åº¦çš„æ•°é‡
            const stats = {
                severity: {},
                path: {},
                type: {}
            };

            currentBugs.forEach(bug => {
                stats.severity[bug.severity] = (stats.severity[bug.severity] || 0) + 1;
                stats.path[bug.file_path] = (stats.path[bug.file_path] || 0) + 1;
                stats.type[bug.type] = (stats.type[bug.type] || 0) + 1;
            });

            // ç”Ÿæˆ Severity ä¸‹æ‹‰é€‰é¡¹ï¼ˆæŒ‰æ•°é‡ä»å¤§åˆ°å°æ’åºï¼‰
            const severitySelect = document.getElementById('severityFilter');
            const currentSeverity = currentFilters.severity;
            const severities = [
                { value: 'high', label: 'High', count: stats.severity.high || 0 },
                { value: 'medium', label: 'Medium', count: stats.severity.medium || 0 },
                { value: 'low', label: 'Low', count: stats.severity.low || 0 }
            ].sort((a, b) => b.count - a.count);  // æŒ‰æ•°é‡é™åº

            severitySelect.innerHTML = `
                <option value="all" ${currentSeverity === 'all' ? 'selected' : ''}>All Severities (${currentBugs.length})</option>
                ${severities.map(s => `
                    <option value="${s.value}" ${s.value === currentSeverity ? 'selected' : ''}>${s.label} (${s.count})</option>
                `).join('')}
            `;

            // ç”Ÿæˆ Path é€‰é¡¹ï¼ˆæŒ‰æ•°é‡ä»å¤§åˆ°å°æ’åºï¼‰
            const pathSelect = document.getElementById('pathFilter');
            const currentPath = currentFilters.path;
            const paths = Object.entries(stats.path)
                .sort((a, b) => b[1] - a[1])  // æŒ‰æ•°é‡é™åº
                .map(([path, count]) => ({ path, count }));
            pathSelect.innerHTML = `
                <option value="all" ${currentPath === 'all' ? 'selected' : ''}>All Paths (${currentBugs.length})</option>
                ${paths.map(p => `
                    <option value="${p.path}" ${p.path === currentPath ? 'selected' : ''}>${p.path} (${p.count})</option>
                `).join('')}
            `;

            // ç”Ÿæˆ Type é€‰é¡¹ï¼ˆæŒ‰æ•°é‡ä»å¤§åˆ°å°æ’åºï¼‰
            const typeSelect = document.getElementById('typeFilter');
            const currentType = currentFilters.type;
            const types = Object.entries(stats.type)
                .sort((a, b) => b[1] - a[1])  // æŒ‰æ•°é‡é™åº
                .map(([type, count]) => ({ type, count }));
            typeSelect.innerHTML = `
                <option value="all" ${currentType === 'all' ? 'selected' : ''}>All Types (${currentBugs.length})</option>
                ${types.map(t => `
                    <option value="${t.type}" ${t.type === currentType ? 'selected' : ''}>${t.type} (${t.count})</option>
                `).join('')}
            `;
        }

        // è·å–å½“å‰ç­›é€‰æ¡ä»¶ä¸‹çš„ bugsï¼ˆç”¨äºè”åŠ¨è®¡ç®—ï¼Œä¸åŒ…æ‹¬å½“å‰æ­£åœ¨ä¿®æ”¹çš„ç­›é€‰å™¨ï¼‰
        function getFilteredBugs() {
            let filtered = bugsData;

            // åº”ç”¨ç­›é€‰
            if (currentFilters.severity !== 'all') {
                filtered = filtered.filter(bug => bug.severity === currentFilters.severity);
            }

            if (currentFilters.path !== 'all') {
                filtered = filtered.filter(bug => bug.file_path === currentFilters.path);
            }

            if (currentFilters.type !== 'all') {
                filtered = filtered.filter(bug => bug.type === currentFilters.type);
            }

            return filtered;
        }

        // è®¾ç½®ç­›é€‰æ§ä»¶
        function setupFilterControls() {
            // Severity ä¸‹æ‹‰æ¡†
            document.getElementById('severityFilter').addEventListener('change', (e) => {
                currentFilters.severity = e.target.value;
                updateFiltersAndRender();
            });

            // Path ä¸‹æ‹‰æ¡†
            document.getElementById('pathFilter').addEventListener('change', (e) => {
                currentFilters.path = e.target.value;
                updateFiltersAndRender();
            });

            // Type ä¸‹æ‹‰æ¡†
            document.getElementById('typeFilter').addEventListener('change', (e) => {
                currentFilters.type = e.target.value;
                updateFiltersAndRender();
            });
        }

        // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹å¹¶é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆè”åŠ¨ï¼‰
        function updateFiltersAndRender() {
            generateFilterOptions();  // é‡æ–°ç”Ÿæˆé€‰é¡¹ï¼ˆè”åŠ¨æ›´æ–°ï¼‰
            renderBugsList();          // æ¸²æŸ“ bug åˆ—è¡¨
        }

        // å¤„ç† URL hash
        function handleUrlHash() {
            const hash = window.location.hash.slice(1); // ç§»é™¤ # å·
            if (hash) {
                // æŸ¥æ‰¾åŒ¹é…çš„ bug
                const filteredBugs = filterAndSortBugs();
                const bugIndex = filteredBugs.findIndex(bug => bug.id === hash);

                if (bugIndex !== -1) {
                    // æ‰¾åˆ°äº†ï¼Œé€‰æ‹©è¿™ä¸ª bug
                    selectBug(bugIndex);
                }
            }
        }

        // ç›‘å¬ hash å˜åŒ–
        window.addEventListener('hashchange', () => {
            handleUrlHash();
        });

        // æ¸²æŸ“ Bug åˆ—è¡¨
        function renderBugsList() {
            const bugsList = document.getElementById('bugsList');
            const filteredBugs = filterAndSortBugs();

            if (filteredBugs.length === 0) {
                bugsList.innerHTML = '<div class="empty-state">No bugs found</div>';
                return;
            }

            bugsList.innerHTML = filteredBugs.map((bug, index) => `
                <div class="bug-item" onclick="selectBug(${index})" data-index="${index}" data-bug-id="${bug.id}" data-severity="${bug.severity}">
                    <div class="bug-id">${bug.id}</div>
                    <div class="bug-severity ${bug.severity}">${bug.severity}</div>
                    <div class="bug-type">${bug.type}</div>
                    <div class="bug-location">${bug.file_path}:${bug.function_name}</div>
                </div>
            `).join('');

            // å¦‚æœæœ‰é€‰ä¸­çš„ bugï¼Œæ¸…é™¤é€‰ä¸­çŠ¶æ€
            selectedBugIndex = -1;
            document.querySelector('.code-pane').innerHTML = '<div class="empty-state">ğŸ‘ˆ Select a bug from the list to view details</div>';
        }

        // ç­›é€‰å’Œæ’åº Bug
        function filterAndSortBugs() {
            let filtered = bugsData;

            // åº”ç”¨ç­›é€‰
            if (currentFilters.severity !== 'all') {
                filtered = filtered.filter(bug => bug.severity === currentFilters.severity);
            }

            if (currentFilters.path !== 'all') {
                filtered = filtered.filter(bug => bug.file_path === currentFilters.path);
            }

            if (currentFilters.type !== 'all') {
                filtered = filtered.filter(bug => bug.type === currentFilters.type);
            }

            // æŒ‰ bug id å‡åºæ’åº
            filtered.sort((a, b) => {
                // æå– bug id ä¸­çš„æ•°å­—è¿›è¡Œæ¯”è¾ƒ
                const aNum = parseInt(a.id.replace(/\D/g, '')) || 0;
                const bNum = parseInt(b.id.replace(/\D/g, '')) || 0;
                return aNum - bNum;
            });

            return filtered;
        }

        // é€‰æ‹© Bug
        function selectBug(index) {
            selectedBugIndex = index;

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.bug-item').forEach(item => {
                item.classList.remove('selected');
            });

            const selectedItem = document.querySelector(`.bug-item[data-index="${index}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }

            // æ˜¾ç¤º Bug è¯¦æƒ…å’Œä»£ç 
            const filteredBugs = filterAndSortBugs();
            const bug = filteredBugs[index];

            // æ›´æ–° URL hash
            window.location.hash = bug.id;

            displayBugDetails(bug);
        }

        // æ˜¾ç¤º Bug è¯¦æƒ…
        async function displayBugDetails(bug) {
            const codePane = document.querySelector('.code-pane');

            codePane.innerHTML = '<div class="empty-state">Loading...</div>';

            let sourceCode;

            if (embedMode) {
                // åµŒå…¥æ¨¡å¼ï¼šä» sourceFiles å¯¹è±¡è·å–æºç 
                sourceCode = sourceFiles[bug.file_path];
                if (!sourceCode) {
                    sourceCode = `// Source file not found in embedded data: ${bug.file_path}`;
                }
                displayCodeWithBug(bug, sourceCode);
            } else {
                // åŠ¨æ€åŠ è½½æ¨¡å¼ï¼šä»æ–‡ä»¶ç³»ç»Ÿè¯»å–
                try {
                    const response = await fetch(`file:///${bug.file_path}`);

                    if (response.ok) {
                        sourceCode = await response.text();
                    } else {
                        sourceCode = `// Unable to load source file: ${bug.file_path}\\n// Please ensure the file exists and is accessible.`;
                    }

                    displayCodeWithBug(bug, sourceCode);

                } catch (error) {
                    // æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    codePane.innerHTML = `
                        <div class="bug-details">
                            <h3>${bug.id} - ${bug.type} [${bug.severity.toUpperCase()}]</h3>
                            <p>${bug.description}</p>
                            <p><span class="label">Suggestion:</span> ${bug.suggestion}</p>
                        </div>
                        <div class="code-header">âš ï¸ Unable to load source file</div>
                        <div style="color: #858585; padding: 20px;">
                            Source code cannot be displayed because the file could not be loaded.<br>
                            File path: ${bug.file_path}<br><br>
                            Please ensure:<br>
                            1. The file exists at the specified location<br>
                            2. You have permission to read the file<br>
                            3. The HTML file is opened from a local file system (file:// protocol)
                        </div>
                    `;
                }
            }
        }

        // æ˜¾ç¤ºå¸¦æœ‰ Bug æ ‡è®°çš„ä»£ç ï¼ˆä½¿ç”¨ POIï¼‰
        function displayCodeWithBug(bug, sourceCode) {
            const codePane = document.querySelector('.code-pane');

            // æ„å»º HTML
            let html = `
                <div class="bug-details">
                    <h3>${bug.id} - ${bug.type} [${bug.severity.toUpperCase()}]</h3>
                    <p>${bug.description}</p>
                    <p><span class="label">Suggestion:</span> ${bug.suggestion}</p>
                </div>
                <div class="code-header">${bug.function_name} @ ${bug.file_path}</div>
                <div class="code-content">
            `;

            // embedMode: ä½¿ç”¨é¢„å…ˆæå–çš„ snippet
            if (bug.function_snippet) {
                const snippet = bug.function_snippet;
                const snippetLines = snippet.snippet.split('\n');
                const snippetStartLine = snippet.snippet_start_line;
                const bugPoiStart = snippet.poi_start_line;
                const bugPoiEnd = snippet.poi_end_line;

                // è®¡ç®— bug åœ¨ snippet ä¸­çš„ç»å¯¹ä½ç½®ï¼ˆç”¨äºé«˜äº® bug POIï¼‰
                // bug_poi ä¸­å·²ç»æ˜¯ç»å¯¹è¡Œå·
                const bugAbsoluteStart = bug.bug_poi.start_line;
                const bugAbsoluteEnd = bug.bug_poi.end_line;

                for (let i = 0; i < snippetLines.length; i++) {
                    const lineNum = snippetStartLine + i;
                    // é«˜äº® bug POI è¡Œ
                    const isBugLine = bugAbsoluteStart > 0 && lineNum >= bugAbsoluteStart && lineNum <= bugAbsoluteEnd;
                    const lineClass = isBugLine ? 'code-line highlighted' : 'code-line';

                    html += `<div class="${lineClass}"><div class="line-number">${lineNum}</div><div class="line-content">${escapeHtml(snippetLines[i])}</div></div>`;
                }
            } else {
                // é embedMode: ä» sourceCode åŠ¨æ€æå– bug POI snippet
                const lines = sourceCode.split('\n');
                const functionStartLine = bug.function_poi.start_line;

                // bug_poi ä¸­å·²ç»æ˜¯ç»å¯¹è¡Œå·
                let bugAbsoluteStart = bug.bug_poi.start_line;
                let bugAbsoluteEnd = bug.bug_poi.end_line;

                if (bugAbsoluteStart === 0) {
                    // å¦‚æœæ²¡æœ‰ bug POIï¼Œä½¿ç”¨å‡½æ•°èµ·å§‹è¡Œ
                    bugAbsoluteStart = functionStartLine;
                    bugAbsoluteEnd = functionStartLine;
                }

                // æå– bug POI Â± 5 è¡Œ
                const contextLines = 5;
                const snippetStart = Math.max(1, bugAbsoluteStart - contextLines);
                const snippetEnd = Math.min(lines.length, bugAbsoluteEnd + contextLines);

                for (let i = snippetStart - 1; i < snippetEnd; i++) {
                    const lineNum = i + 1;
                    const isBugLine = bugAbsoluteStart > 0 && lineNum >= bugAbsoluteStart && lineNum <= bugAbsoluteEnd;
                    const lineClass = isBugLine ? 'code-line highlighted' : 'code-line';

                    html += `<div class="${lineClass}"><div class="line-number">${lineNum}</div><div class="line-content">${escapeHtml(lines[i])}</div></div>`;
                }
            }

            html += '</div>';

            // æ·»åŠ  Callers éƒ¨åˆ†ï¼ˆä½¿ç”¨ POIï¼‰
            if (bug.callers && bug.callers.length > 0) {
                html += '<div class="caller-section">';
                html += '<div class="caller-header">Callers (Functions that call this function)</div>';

                for (let i = 0; i < bug.callers.length; i++) {
                    const caller = bug.callers[i];
                    const filePath = caller.file_path || 'Unknown';
                    const functionName = caller.function_name || 'Unknown';
                    const callLines = caller.call_lines || [];

                    html += `
                        <div class="caller-item">
                            <div class="caller-label">[${i + 1}/${bug.callers.length}] ${functionName} @ ${filePath}</div>
                            <div class="code-content">
                    `;

                    // embedMode: ä½¿ç”¨é¢„å…ˆæå–çš„ snippet
                    if (caller.snippet) {
                        const snippet = caller.snippet;
                        const snippetLines = snippet.snippet.split('\n');
                        const snippetStartLine = snippet.snippet_start_line;

                        for (let j = 0; j < snippetLines.length; j++) {
                            const lineNum = snippetStartLine + j;
                            const isHighlighted = callLines.includes(lineNum);
                            const lineClass = isHighlighted ? 'code-line highlighted' : 'code-line';
                            html += `<div class="${lineClass}"><div class="line-number">${lineNum}</div><div class="line-content">${escapeHtml(snippetLines[j])}</div></div>`;
                        }
                    } else {
                        // é embedMode: ä» sourceFiles åŠ¨æ€æå– caller POI snippet
                        const callerSourceCode = sourceFiles[filePath];
                        if (callerSourceCode) {
                            const lines = callerSourceCode.split('\n');

                            // ä½¿ç”¨ callLines æ¥ç¡®å®š snippet èŒƒå›´ï¼ˆè€Œä¸æ˜¯æ•´ä¸ªå‡½æ•°ï¼‰
                            let poiStart, poiEnd;
                            if (callLines && callLines.length > 0) {
                                poiStart = Math.min(...callLines);
                                poiEnd = Math.max(...callLines);
                            } else {
                                poiStart = caller.start_line || 1;
                                poiEnd = poiStart;
                            }

                            // æå– POI Â± 5 è¡Œ
                            const contextLines = 5;
                            const snippetStart = Math.max(1, poiStart - contextLines);
                            const snippetEnd = Math.min(lines.length, poiEnd + contextLines);

                            for (let j = snippetStart - 1; j < snippetEnd; j++) {
                                const lineNum = j + 1;
                                const isHighlighted = callLines.includes(lineNum);
                                const lineClass = isHighlighted ? 'code-line highlighted' : 'code-line';
                                html += `<div class="${lineClass}"><div class="line-number">${lineNum}</div><div class="line-content">${escapeHtml(lines[j])}</div></div>`;
                            }
                        } else {
                            html += `<div class="code-line"><div class="line-content">Source file not available</div></div>`;
                        }
                    }

                    html += `
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
            }

            // æ·»åŠ  Inferred Callers éƒ¨åˆ†ï¼ˆä½¿ç”¨ POIï¼‰
            if (bug.inferred_callers && bug.inferred_callers.length > 0) {
                html += '<div class="caller-section">';
                html += '<div class="caller-header">Inferred Callers (Potential callers detected by analysis)</div>';

                for (let i = 0; i < bug.inferred_callers.length; i++) {
                    const inferredCaller = bug.inferred_callers[i];
                    const hint = inferredCaller.hint || '';
                    const filePath = inferredCaller.file_path || 'Unknown';
                    const functionName = inferredCaller.function_name || 'Unknown';
                    const inferenceLines = inferredCaller.inference_lines || [];

                    html += `
                        <div class="caller-item">
                            <div class="caller-hint">${escapeHtml(hint)}</div>
                            <div class="caller-label">[${i + 1}/${bug.inferred_callers.length}] ${functionName} @ ${filePath}</div>
                            <div class="code-content">
                    `;

                    // embedMode: ä½¿ç”¨é¢„å…ˆæå–çš„ snippet
                    if (inferredCaller.snippet) {
                        const snippet = inferredCaller.snippet;
                        const snippetLines = snippet.snippet.split('\n');
                        const snippetStartLine = snippet.snippet_start_line;

                        for (let j = 0; j < snippetLines.length; j++) {
                            const lineNum = snippetStartLine + j;
                            const isHighlighted = inferenceLines.includes(lineNum);
                            const lineClass = isHighlighted ? 'code-line highlighted' : 'code-line';
                            html += `<div class="${lineClass}"><div class="line-number">${lineNum}</div><div class="line-content">${escapeHtml(snippetLines[j])}</div></div>`;
                        }
                    } else {
                        // é embedMode: ä» sourceFiles åŠ¨æ€æå– inferred caller POI snippet
                        const inferredSourceCode = sourceFiles[filePath];
                        if (inferredSourceCode) {
                            const lines = inferredSourceCode.split('\n');

                            // ä½¿ç”¨ inferenceLines æ¥ç¡®å®š snippet èŒƒå›´ï¼ˆè€Œä¸æ˜¯æ•´ä¸ªå‡½æ•°ï¼‰
                            let poiStart, poiEnd;
                            if (inferenceLines && inferenceLines.length > 0) {
                                poiStart = Math.min(...inferenceLines);
                                poiEnd = Math.max(...inferenceLines);
                            } else {
                                poiStart = inferredCaller.start_line || 1;
                                poiEnd = poiStart;
                            }

                            // æå– POI Â± 5 è¡Œ
                            const contextLines = 5;
                            const snippetStart = Math.max(1, poiStart - contextLines);
                            const snippetEnd = Math.min(lines.length, poiEnd + contextLines);

                            for (let j = snippetStart - 1; j < snippetEnd; j++) {
                                const lineNum = j + 1;
                                const isHighlighted = inferenceLines.includes(lineNum);
                                const lineClass = isHighlighted ? 'code-line highlighted' : 'code-line';
                                html += `<div class="${lineClass}"><div class="line-number">${lineNum}</div><div class="line-content">${escapeHtml(lines[j])}</div></div>`;
                            }
                        } else {
                            html += `<div class="code-line"><div class="line-content">Source file not available</div></div>`;
                        }
                    }

                    html += `
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
            }

            codePane.innerHTML = html;

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            codePane.scrollTop = 0;
        }

        // HTML è½¬ä¹‰ï¼ˆä¿ç•™ç©ºæ ¼å’Œç¼©è¿›ï¼‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            // å°†ç©ºæ ¼æ›¿æ¢ä¸º &nbsp; ä»¥ä¿ç•™ç¼©è¿›
            return div.innerHTML.replace(/ /g, '&nbsp;');
        }

        // æ ¼å¼åŒ– caller codeï¼Œé«˜äº®è°ƒç”¨è¡Œï¼ˆä»¥ ">>> " å¼€å¤´ï¼‰
        function formatCallerCode(code) {
            const lines = code.split('\n');
            const formattedLines = lines.map(line => {
                if (line.startsWith('>>> ')) {
                    // ç§»é™¤ ">>> " æ ‡è®°ï¼Œå¹¶æ·»åŠ é«˜äº®ç±»
                    const cleanLine = line.substring(4);
                    return `<span class="call-line">${escapeHtml(cleanLine)}</span>`;
                } else {
                    return escapeHtml(line);
                }
            });
            return formattedLines.join('\n');
        }

        // å¯åŠ¨åº”ç”¨
        init();
    </script>
</body>
</html>
