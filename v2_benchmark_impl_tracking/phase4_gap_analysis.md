# Phase 4 Gap Analysis: 当前进度 vs 最终目标

**分析日期**: 2025-10-19
**当前状态**: Phase 3 完成 ✅ (85 bugs)
**最终目标**: 105 bugs (v2_benchmark_design_proposal.md Section 2.2)

---

## 执行摘要

| 维度 | 设计规划 | 已实现 | 差距 | 完成度 |
|------|---------|--------|------|--------|
| **总 Bug 数** | 105 | **85** | **20** | **81.0%** ✅ |
| **大类别数** | 8 | **8** | **0** | **100%** ✅ |
| **子类别数** | 26 | **16** | **10** | **61.5%** |

**核心差距**: 剩余 20 bugs，分布在已有类别的深度扩展

---

## 当前完成情况（按类别）

| 类别 | 规划 | 已实现 | 完成度 | 状态 |
|------|------|--------|--------|------|
| 1. 资源管理 | 30 | 17 | 56.7% | ⚠️ 缺 13 |
| 2. 并发安全 | 24 | 7 | 29.2% | ⚠️ 缺 17 |
| 3. 错误处理 | 16 | 10 | 62.5% | ⚠️ 缺 6 |
| 4. 输入验证 | 10 | 10 | 100% | ✅ 完成 |
| 5. 注入漏洞 | 20 | 15 | 75.0% | ⚠️ 缺 5 |
| 6. 数据流 | 15 | 15 | 100% | ✅ 完成 |
| 7. 类型安全 | 10 | 3 | 30.0% | ⚠️ 缺 7 |
| 8. API 使用 | 10 | 2 | 20.0% | ⚠️ 缺 8 |

**总计**: 135 bugs 规划 vs 79 bugs 已实现（ground_truth 统计，实际 85）

---

## 详细 Gap 清单

### 类别 1: 资源管理 (缺 13 bugs)

#### 1-1: 文件泄露 (缺 5 bugs)
- [ ] **RM-FILE-008**: 赋值后未用 (`f = open(); f = None`)
- [ ] **RM-FILE-009**: 返回前未关 (`f=open(); if x: return`)
- [ ] **RM-FILE-010**: finally 缺失
- [ ] **RM-FILE-011**: with 嵌套错误
- [ ] **RM-FILE-012**: close 条件错误

#### 1-2: 线程池泄露 (缺 3 bugs)
- [ ] **RM-POOL-004**: 异步函数泄露 (注意: RM-POOL-003 已实现类似功能)
- [ ] **RM-POOL-005**: 循环创建未释放
- [ ] **RM-POOL-006**: 条件创建泄露

#### 1-3: 网络连接泄露 (缺 4 bugs)
- [ ] **RM-NET-005**: 数据库游标泄露
- [ ] **RM-NET-006**: SMTP 连接泄露 (注意: RM-NET-004 已实现)
- [ ] **RM-NET-007**: FTP 连接泄露
- [ ] **RM-NET-008**: Redis 连接泄露

#### 1-4: 同步原语泄露 (缺 1 bug)
- [ ] **RM-SYNC-004**: Condition 未释放 (高级场景)

---

### 类别 2: 并发安全 (缺 17 bugs) ⚠️ 最大差距

#### 2-1: 竞态条件 (缺 7 bugs)
- [ ] **CONC-RACE-001**: 全局变量写入竞态
- [ ] **CONC-RACE-002**: 全局字典竞态
- [ ] **CONC-RACE-003**: 全局列表竞态
- [ ] **CONC-RACE-004**: 类成员变量竞态
- [ ] **CONC-RACE-005**: 类变量竞态
- [ ] **CONC-RACE-006**: 复合操作竞态
- [ ] **CONC-RACE-010**: 文件读写竞态

**已实现**: CONC-RACE-007~009 (3个)

#### 2-2: 死锁风险 (缺 3 bugs)
- [ ] **CONC-DEAD-004**: 循环等待
- [ ] **CONC-DEAD-005**: 条件变量死锁
- [ ] **CONC-DEAD-006**: Join 死锁

**已实现**: CONC-DEAD-001~003 (3个)

#### 2-3: 异步协程 (缺 7 bugs)
- [ ] **CONC-ASYNC-002**: 同步函数中 await
- [ ] **CONC-ASYNC-003**: 异步中阻塞调用
- [ ] **CONC-ASYNC-004**: Event loop 嵌套
- [ ] **CONC-ASYNC-005**: Task 未 await
- [ ] **CONC-ASYNC-006**: Task 未取消
- [ ] **CONC-ASYNC-007**: async context 泄露
- [ ] **CONC-ASYNC-008**: gather 异常未处理

**已实现**: CONC-ASYNC-001 (1个)

---

### 类别 3: 错误处理 (缺 6 bugs)

#### 3-1: 异常捕获 (缺 6 bugs)
- [ ] **EXC-CATCH-005**: except 仅 pass
- [ ] **EXC-CATCH-006**: 捕获后未记录
- [ ] **EXC-CATCH-007**: 捕获 BaseException
- [ ] **EXC-CATCH-008**: 多余的 except
- [ ] **EXC-CATCH-009**: except 顺序错误
- [ ] **EXC-CATCH-010**: 空 try 块

**已实现**: EXC-CATCH-001~004 (4个)

#### 3-2: 资源清理
✅ **已完成**: EXC-CLEAN-001~006 (6个)

---

### 类别 4: 输入验证
✅ **已完成**: 10/10 bugs (100%)

---

### 类别 5: 注入漏洞 (缺 5 bugs)

#### 5-1: 路径遍历
✅ **已完成**: INJ-PATH-001~009 + INPUT-PATH-003 (10个)

#### 5-2: 命令注入 (缺 3 bugs)
- [ ] **INJ-CMD-004**: os.popen 注入
- [ ] **INJ-CMD-005**: exec 注入
- [ ] **INJ-CMD-006**: compile 注入

**已实现**: INJ-CMD-001~003 (3个)

#### 5-3: SQL 注入 (缺 3 bugs，但只需 2 个)
- [ ] **INJ-SQL-003**: execute 拼接
- [ ] **INJ-SQL-004**: ORM raw 注入
- [ ] **INJ-SQL-005**: 动态表名注入

**已实现**: INJ-SQL-001~002 (2个)
**注意**: 仅需补充 2 个即可达到规划的 5 个

---

### 类别 6: 数据流
✅ **已完成**: 15/15 bugs (100%)

---

### 类别 7: 类型安全 (缺 7 bugs)

#### 7-1: 类型不匹配 (缺 3 bugs)
- [ ] **TYPE-MIS-004**: Union 未收窄
- [ ] **TYPE-MIS-005**: Any 滥用
- [ ] **TYPE-MIS-006**: 类型转换错误

**已实现**: TYPE-MIS-001~003 (3个)

#### 7-2: API 契约违反 (缺 4 bugs)
- [ ] **TYPE-API-001**: 可变默认参数
- [ ] **TYPE-API-002**: 继承签名不一致
- [ ] **TYPE-API-003**: 抽象方法未实现
- [ ] **TYPE-API-004**: 返回类型不一致

**已实现**: 0个

---

### 类别 8: API 使用 (缺 8 bugs)

#### 8-1: 废弃 API (缺 2 bugs)
- [ ] **API-DEP-003**: imp 模块 (注意: API-DEP-002 已实现)
- [ ] **API-DEP-004**: collections ABC

**已实现**: API-DEP-001~002 (2个)

#### 8-2: 危险 API (缺 6 bugs)
- [ ] **API-DANGER-001**: pickle.loads 不可信数据
- [ ] **API-DANGER-002**: yaml.load 不安全
- [ ] **API-DANGER-003**: random 用于安全
- [ ] **API-DANGER-004**: assert 用于验证
- [ ] **API-DANGER-005**: tempfile 固定名称
- [ ] **API-DANGER-006**: MD5/SHA1 密码

**已实现**: 0个

---

## Phase 4 实施建议

### 优先级排序

根据检测价值和实现难度，建议分 2 个批次完成剩余 20 bugs：

#### 🔥 Batch 1: 高价值 + 易实现 (10 bugs)

**目标**: 快速补充关键场景，优先覆盖常见 bug patterns

| Bug ID | 类别 | 难度 | 优先级 | 理由 |
|--------|------|------|--------|------|
| CONC-RACE-001~003 | 并发 | Easy | P0 | 最常见的并发 bugs |
| INJ-CMD-004~006 | 注入 | Easy | P0 | 严重安全漏洞 |
| API-DANGER-001~002 | API | Easy | P0 | 严重安全风险 |
| EXC-CATCH-005~006 | 错误处理 | Easy | P1 | 代码质量问题 |

**工作量预估**: 2-3 天

#### 📦 Batch 2: 深度补充 (10 bugs)

**目标**: 完成设计文档覆盖，达到 105 bugs

| Bug ID | 类别 | 难度 | 优先级 | 理由 |
|--------|------|------|--------|------|
| CONC-ASYNC-002~005 | 并发 | Medium | P1 | 异步编程常见错误 |
| TYPE-API-001~004 | 类型 | Medium | P2 | API 设计问题 |
| RM-FILE-008~010 | 资源 | Medium | P2 | 文件泄露边界场景 |

**工作量预估**: 2-3 天

---

## 可选扩展 (超出 105 目标)

如果有额外时间，可补充以下高价值 bugs：

- **RM-NET-007~008**: FTP/Redis 连接泄露（扩展网络泄露场景）
- **CONC-DEAD-004~006**: 高级死锁场景（提升并发检测能力）
- **INJ-SQL-003~005**: SQL 注入扩展（完善注入检测）

---

## 总结

### 当前状态
- ✅ **Phase 3 完成**: 85 bugs, 8 大类别
- ✅ **基础覆盖**: 4/8 类别达到 100%
- ⚠️ **主要差距**: 并发类别 (29.2%)

### Phase 4 目标
- 🎯 **最终目标**: 105 bugs (+20)
- 📅 **预估工期**: 4-6 天 (Batch 1 + Batch 2)
- 💰 **LLM 成本**: ~$0.20 (20 bugs × $0.01)

### 实施路径
1. **Batch 1** (10 bugs, 2-3 天): 高价值易实现
2. **Batch 2** (10 bugs, 2-3 天): 深度补充
3. **验收测试**: PyScan 检测 + 文档更新
4. **最终交付**: 105 bugs benchmark ✅

---

**创建日期**: 2025-10-19
**最后更新**: 2025-10-19 23:30
**状态**: Phase 4 规划
**下一步**: 执行 Batch 1 (10 bugs)
